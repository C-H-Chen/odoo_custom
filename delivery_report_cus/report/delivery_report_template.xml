<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>
    <template id="report_delivery_report_template"
              t-name="delivery_report_cus.report_delivery_report_template">

      <t t-call="web.html_container">
        <t t-set="docs_data" t-value="docs_data or [{}]"/>
        <t t-foreach="docs_data" t-as="data">

          <!--
            分頁邏輯說明：
            - lines: 原始所有明細
            - first_limit: 第一頁最大列數 (你的需求：4)
            - next_limit: 後續每頁最大列數 (可以調整，例如 20)
            - rem: 剩餘明細（第一頁之後）
            - pages: 剩餘需要的頁數 (不包含第一頁)
            - total_pages: 第一頁 + pages
          -->
          <t t-set="lines" t-value="data.get('lines') or []"/>
          <t t-set="first_limit" t-value="10"/>
          <t t-set="next_limit" t-value="10"/>
          <!-- 使用與第一頁相同的 page_size -->
          <t t-set="page_size" t-value="first_limit"/>
          <t t-set="total_pages" t-value="1 if len(lines) == 0 else ((len(lines) + page_size - 1) // page_size)"/>

          <!-- 依頁數產生實際 page(s) -->
          <t t-foreach="range(total_pages)" t-as="page_index">
            <div class="article"
               t-attf-style="#{ 'page-break-after: always;' if page_index &lt; (total_pages - 1) else 'page-break-after: auto;' }">

              <div class="page">
                <style>
                  /* 頁面尺寸與內框 size: 210mm 140mm; margin: 7mm;  */
                  @page {}
                  html, body {
                    font-family: "Noto Sans CJK TC", "Microsoft JhengHei", "WenQuanYi Micro Hei", "DejaVu Sans", sans-serif;
                    font-size:11pt; margin:0; padding:0; color:#000;
                  }
                  /* 注意：移除強制 min-height，讓內容決定高度，避免多出空白頁.page { padding:7mm; box-sizing:border-box; } */
                  

                  .title { text-align:center; font-size:18pt; margin-bottom:12px; }

                  .company-info, .company-info tr, .company-info td {
                    border: 0 !important;
                    padding: 0;
                    vertical-align: top;
                  }
                  .company-info { border-collapse: separate !important; white-space:nowrap; }

                  /* 單表格設定 */
                  .single-table {
                    width:100%;
                    border:2px solid #000;  /* 保留表格外框 */
                    border-collapse:collapse;
                    font-size:11pt;
                    page-break-inside: auto; /* 允許表格在頁內斷 */
                  }

                  /* 確保 thead/tbody 正確處理以利穩定斷頁（避免 header 被視為 body）*/
                  .single-table thead { display: table-header-group; }
                  .single-table tbody { display: table-row-group; }
                  .single-table tfoot { display: table-row-group; }

                  /* 標題欄保留上下框線 */
                  .single-table th {
                    border:1px solid #000;
                    padding:6px 4px;
                    vertical-align:top;
                    word-break:break-word;
                    text-align:center;
                    font-weight: normal !important;
                  }

                  /*
                    關鍵：把 td 的 padding 轉移給 .cell-inner，td 本身設為無內距
                    並用 .cell-inner 統一高度與行內置中（或自訂）
                  */
                  .single-table tbody tr,
                  .single-table tbody tr.empty-row {
                      border-top: none !important;
                      border-bottom: none !important;
                  }
                  .single-table tbody tr td,
                  .single-table tbody tr.empty-row td {
                      border-left: 1px solid #000 !important;
                      border-right: 1px solid #000 !important;
                      border-top: none !important;
                      border-bottom: none !important;
                      padding:0 !important;          /* 重要：td 不留內距 */
                      vertical-align:top;
                      word-break:break-word;
                  }

                  /* 內部 cell wrapper：固定高度、統一內距、內容超出隱藏 */
                  .single-table .cell-inner {
                      display: block;
                      box-sizing: border-box;
                      height: 20px;       /* ← 調整這個值即可改每列高度（包含上下內距） */
                      line-height: 20px;  /* 垂直置中內容（若需要） */
                      padding: 0 6px;     /* 左右內距（上/下內距已由 height+line-height 控制） */
                      overflow: hidden;   /* 超長或換行內容隱藏，確保高度一致 */
                      white-space: nowrap; /* 若要允許換行改成 normal 並調整 height */
                  }

                  /* 空白補滿列內部也使用 cell-inner（讓空列高度一致） */
                  .empty-row td .cell-inner { height: 20px; }

                  /* 不在 tr 上強制 avoid，改交給 table 的分頁策略 */
                  /* 移除: .single-table tr, .single-table tbody tr { page-break-inside: avoid; } */

                  .single-table tr.client-row { border:none !important; padding:0 !important; }
                  .single-table tr.client-row td { border:none !important; padding:2px 0 !important; }
                  
                  .single-table tr.totals-row td {
                      border-top: 1px solid #000 !important;
                      border-bottom: none !important;
                      padding: 0 !important; 
                  }

                  /* 貨單附註列邊框 */
                  .single-table tr.note-row td {
                      border-top: 1px solid #000 !important;
                      border-bottom: 1px solid #000 !important;
                      height: 35px;       /* 直接設定高度 */
                      vertical-align:   top; /* 或 middle, bottom */
                  }

                  .client-row .client-wrapper { position: relative; height: 17px; }
                  .client-row .client-cell {
                    position: absolute;
                    top: 0;
                    white-space: nowrap;
                    overflow: visible;
                    line-height: 10px;
                  }

                  .client-first  { left: 1mm; width: 60mm; }
                  .client-sec    { left: 75mm; width: 60mm; }
                  .client-third  { left: 150mm; width: 50mm; }
                  .client-wide   { left: 1mm; max-width: 130mm; white-space:normal; }

                  .client-value { display:inline-block; min-width:0; }

                  .first-copy {
                    position:absolute;
                    top:45px;
                    right:0mm;
                    font-size:10pt;
                    text-align:center;
                    writing-mode: vertical-rl;
                    text-orientation: upright;
                    margin-top: 137px;
                  }
                  .first-copy div { line-height:12pt; }

                  .hide-label { visibility:hidden; }

                  .totals-area div.tot-line { margin-bottom:8px; text-align:center; }

                  .single-table .cell-inner.multiline {
                      height: 80px !important;           /* 讓高度隨內容而定 */
                      line-height: normal !important;    /* 使用正常行高 */
                      white-space: normal !important;    /* 允許換行 */
                      overflow: visible !important;      /* 內容不被裁切 */
                      padding: 4px 6px !important;       /* 與明細左右距離一致（可調） */
                      box-sizing: border-box;
                  }
                  .sign-vertical { text-align:left; line-height:14pt; }
                  .sign-vertical div { display:block; }

                  .driver { text-align:right; margin-right:75px; margin-top:0px; font-size:10pt; }
                  
                  .driver.hide {
                      visibility: hidden !important;
                  }

                  .hide-cell {
                      visibility: hidden !important;
                      height: 14px; /* 與原本行高一致 */
                      display: inline-block; /* 確保仍占空間 */
                  }

                </style>

                <div class="title">出&#160;&#160;&#160;&#160;貨&#160;&#160;&#160;&#160;單</div>

                <table class="company-info" style="margin-bottom:6px; border:none; width:100%;">
                  <tr>
                    <td style="width:60%; border:none; vertical-align:top;">
                      <div style="font-size:12pt; margin-bottom:6px;">
                        <t t-esc="data['company']['name']"/>
                      </div>
                    </td>
                    <td style="width:40%; border:none; font-size:10pt; vertical-align:top;">
                      <div style="margin-bottom:4px;"><span class="hide-cell">地&#160;&#160;&#160;&#160;&#160;址: </span><t t-esc="data['company']['street_city']"/></div>
                      <div style="margin-bottom:4px;">
                        <span style="display:inline-block; margin-right:30px;">
                          <span class="hide-cell">電&#160;&#160;&#160;&#160;&#160;話: </span>
                          <t t-esc="data['company']['phone']"/>
                        </span>
                        <span style="display:inline-block; margin-right:0;">
                          <span class="hide-cell">傳真: </span>
                          <t t-esc="data['company']['fax'] or '00-1234567'"/>
                        </span>
                      </div>
                      <div style="margin-bottom:4px;">
                        <span class="hide-cell">E-mail: </span>
                        <t t-esc="data['company']['email']"/>
                      </div>
                    </td>
                  </tr>
                </table>

                <div class="first-copy">
                  <div>第</div><div>一</div><div>聯</div><div>:</div>
                  <div>公</div><div>司</div><div>留</div><div>存</div><div>聯</div>
                </div>

                <table class="single-table">
                  <colgroup>
                    <col class="c-prodcode" style="width:20%"/>
                    <col class="c-name" style="width:30%"/>
                    <col class="c-qty" style="width:11%"/>
                    <col class="c-uom" style="width:6%"/> 
                    <col class="c-unitpr" style="width:11%"/>
                    <col class="c-amt" style="width:11%"/>
                    <col class="c-note" style="width:11%"/>
                  </colgroup>

                  <!-- 客戶資訊列 -->
                  <tr class="client-row">
                    <td colspan="7" style="padding:6px 8px;">
                      <div class="client-wrapper">
                        <div class="client-cell client-first">
                            <span class="hide-cell">客戶名稱: </span>
                            <t t-esc="data['partner']['name']"/>
                        </div>
                        <div class="client-cell client-sec">
                            <span class="hide-cell">客戶編號: </span>
                            <t t-esc="data['partner']['ref'] or 'N/A'"/>
                        </div>
                        <div class="client-cell client-third">
                            <span class="hide-cell">單據日期: </span>
                            <t t-esc="data['date']"/>
                        </div>
                      </div>
                    </td>
                  </tr>

                  <tr class="client-row">
                    <td colspan="7" style="padding:6px 8px;">
                      <div class="client-wrapper">
                        <div class="client-cell client-first">
                            <span class="hide-cell">統一編號: </span>
                            <t t-esc="data['partner']['vat'] or 'N/A'"/>
                        </div>
                        <div class="client-cell client-sec">
                            <span class="hide-cell">連絡電話: </span>
                            <t t-esc="data['partner']['phone'] or 'N/A'"/>
                        </div>
                        <div class="client-cell client-third">
                            <span class="hide-cell">單據號碼: </span>
                            <t t-esc="data['name']"/>
                        </div>
                      </div>
                    </td>
                  </tr>

                  <tr class="client-row">
                    <td colspan="7" style="padding:6px 8px;">
                      <div class="client-wrapper">
                        <div class="client-cell client-first">
                            <span class="hide-cell">聯&#8201;&#8201;絡&#8201;&#8201;&#8201;人: </span>
                            <t t-esc="data['partner']['contact'] or 'N/A'"/>
                        </div>
                        <div class="client-cell client-sec">
                            <span class="hide-cell">傳&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;真: </span>
                            <t t-esc="data['partner']['fax'] or 'N/A'"/>
                        </div>
                        <div class="client-cell client-third">
                            <span class="hide-cell">製&#8201;&#8201;表&#8201;&#8201;&#8201;人: </span>
                            <t t-esc="data['user_name'] or 'N/A'"/>
                        </div>
                      </div>
                    </td>
                  </tr>

                  <tr class="client-row">
                    <td colspan="7" style="padding:6px 8px;">
                      <div class="client-wrapper">
                        <div class="client-cell client-wide">
                            <span class="hide-cell">送貨地址: </span>
                            <t t-esc="data['partner']['street_city'] or 'N/A'"/>
                        </div>
                        <div class="client-cell client-third">
                            <span class="hide-cell">發票號碼: </span>
                            <t t-esc="data['invoice_ref'] or 'N/A'"/>
                        </div>
                      </div>
                    </td>
                  </tr>

                  <!-- 明細表標題 -->
                  <tr>
                    <th><span class="hide-cell">產&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;品&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;編&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;號</span></th>
                    <th><span class="hide-cell">品&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;名&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;/&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;規&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;格</span></th>
                    <th><span class="hide-cell">數&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;量</span></th>
                    <th><span class="hide-cell">單位</span></th>
                    <th><span class="hide-cell">單&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;價</span></th>
                    <th><span class="hide-cell">⾦&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;額</span></th>
                    <th><span class="hide-cell">貨品備註</span></th>
                  </tr>

                  <tbody>
                    <!-- 決定本頁要顯示的明細 chunk -->
                    <t t-set="start" t-value="page_index * page_size"/>
                    <t t-set="chunk" t-value="lines[start:start + page_size]"/>

                    <!-- 列印本頁 chunk（每個 td 內容包 cell-inner） -->
                    <t t-foreach="chunk" t-as="line">
                      <tr>
                        <td><div class="cell-inner"><t t-esc="line['product_code'] or 'N/A'"/></div></td>
                        <td><div class="cell-inner"><t t-esc="line['product_name'] or 'N/A'"/></div></td>
                        <td><div class="cell-inner"><t t-esc="line['qty'] or '0'"/></div></td>
                        <td><div class="cell-inner"><t t-esc="line['uom'] or 'PCS'"/></div></td>
                        <td><div class="cell-inner"><t t-esc="line['price_unit'] or '0.00'"/></div></td>
                        <td><div class="cell-inner"><t t-esc="line['subtotal'] or '0.00'"/></div></td>
                        <td><div class="cell-inner"><t t-esc="line['note'] or ''"/></div></td>
                      </tr>
                    </t>

                    <!-- 若本頁為最後頁 (page_index == total_pages-1) 則補空白列至 target_lines (使 totals 在固定位置) -->
                    <t t-if="page_index == (total_pages - 1)">
                      <!-- 最後頁目標列數使用 page_size（和第一頁一致） -->
                      <t t-set="target_lines" t-value="page_size"/>
                      <t t-set="current_count" t-value="len(chunk)"/>
                      <t t-set="empty_count" t-value="(target_lines - current_count) if (target_lines - current_count) &gt; 0 else 0"/>
                      <t t-if="empty_count &gt; 0">
                        <t t-foreach="range(empty_count)" t-as="i">
                          <tr class="empty-row">
                            <td><div class="cell-inner"></div></td>
                            <td><div class="cell-inner"></div></td>
                            <td><div class="cell-inner"></div></td>
                            <td><div class="cell-inner"></div></td>
                            <td><div class="cell-inner"></div></td>
                            <td><div class="cell-inner"></div></td>
                            <td><div class="cell-inner"></div></td>
                          </tr>
                        </t>
                      </t>
                    </t>
                  </tbody>

                  <!-- 只有最後一頁顯示備註 / 合計 / 簽收 -->
                  <t t-if="page_index == (total_pages - 1)">

                  <!-- 備註 / 合計 / 簽收 -->
                  <tr class="totals-row">
                    <!-- 備註：佔左側 3 欄 -->
                    <td colspan="3" style="padding:0 6px 0 6px; vertical-align:top; text-align:left; white-space:pre-line;">
                      <div style="margin-top:-13px; margin-bottom:0;"><span class="hide-cell">備註:</span></div>
                      <div style="margin-top:-10px;"><t t-esc="data.get('note') or '※ 本 交 易 為 附 條 件 買 賣，...'"/></div>
                    </td>

                    <!-- 合計標籤：佔 2 欄 -->
                    <td colspan="2" style="padding:0; vertical-align:top;">
                      <div class="cell-inner multiline">
                        <div class="tot-line"><span class="hide-cell">合&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;計</span></div>
                        <div class="tot-line"><span class="hide-cell">營&#160;&#160;&#160;&#160;&#160;&#160;&#160;業&#160;&#160;&#160;&#160;&#160;&#160;&#160;稅</span></div>
                        <div class="tot-line"><span class="hide-cell">總&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;計</span></div>
                      </div>
                    </td>

                    <!-- 合計數值欄（會自動展高） -->
                    <td style="padding:0; vertical-align:top;">
                      <div class="cell-inner multiline">
                        <div class="tot-line" style="text-align:left;"><t t-esc="data.get('amount_untaxed') or ''"/></div>
                        <div class="tot-line" style="text-align:left;"><t t-esc="data.get('amount_tax') or ''"/></div>
                        <div class="tot-line" style="text-align:left;"><t t-esc="data.get('amount_total') or ''"/></div>
                      </div>
                    </td>

                    <!-- 簽收欄：-->
                    <td style="padding:0; vertical-align:top; border:1px solid #000;">
                      <!-- <div class="cell-inner multiline sign-vertical"> -->
                      <div>簽</div>
                      <div>收</div>
                      <div>&#160;:</div>
                      <!-- </div> -->
                    </td>
                  </tr>

                    <!-- 貨單附註 -->
                    <tr class="note-row">
                      <td style="text-align:center; border-top:1px solid #000;"><span class="hide-cell">貨&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;單&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;附&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;註</span></td>
                      <td colspan="6" style="border-top:1px solid #000;"></td>
                    </tr>

                  </t>

                </table>

                <!-- 只有最後一頁顯示 driver（司機） -->
                <t t-if="page_index == (total_pages - 1)">
                  <div class="driver" style="display: flex; justify-content: space-between; width:100%; white-space: nowrap;">
                      <span style="visibility:hidden;">司&#160;&#160;機&#160;&#160;:&#160;&#160;</span>
                      <span style="text-align: right;"><t t-esc="data.get('driver_name', 'Admin')"/></span>
                  </div>
                </t>
              </div>
            </div>
          </t>
        </t>
      </t>
    </template>
  </data>
</odoo>
